# -*- Mode: Makefile; tab-width: 8; indent-tabs-mode: t; -*-

PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_VERSION = @PACKAGE_VERSION@

noinst_DATA = xpi

JAR_TARGET_FILES = 					\
	content					\
	locale					\
	skin

XPI_TARGET_FILES = 					\
	install.rdf				\
	components/*.js				\
	chrome				\
	defaults				\
	modules				\
	chrome.manifest

xpi:
	(rm -rf chrome && \
	 mkdir -p chrome && \
	 zip -q -r -9 chrome/$(PACKAGE_NAME).jar $(JAR_TARGET_FILES) -x \*.git/\* && \
	 rm -f $(PACKAGE_NAME)-$(PACKAGE_VERSION).xpi && \
	 rm -f $(PACKAGE_NAME)-$(PACKAGE_VERSION)-noupdate.xpi && \
	 zip -q -r -9 $(PACKAGE_NAME)-$(PACKAGE_VERSION).xpi $(XPI_TARGET_FILES) -x \*.git/\* && \
	 cp -f $(PACKAGE_NAME)-$(PACKAGE_VERSION).xpi $(PACKAGE_NAME)-$(PACKAGE_VERSION)-noupdate.xpi && \
	 rm -rf xpi_temp && \
	 mkdir -p xpi_temp && \
	 sed -e "s#^.*<em:*\\(updateURL\\|updateKey\\)>.*</em:*\\(updateURL\\|updateKey\\)>##g" -e "s#^.*em:*\\(updateURL\\|updateKey\\)=\\(\\".*\\"\\|'.*'\\)##g" install.rdf > xpi_temp/install.rdf && \
	 cd xpi_temp && \
	 zip -q -9 ../$(PACKAGE_NAME)-$(PACKAGE_VERSION)-noupdate.xpi install.rdf && \
	 cd ..)
